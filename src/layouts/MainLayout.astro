---
/**
 * MainLayout.astro
 *
 * Layout principal de la aplicación. Maneja:
 * - SEO y meta tags (Open Graph, Twitter Cards)
 * - Google Analytics 4 con Consent Mode v2
 * - Widget de chat de AI Revolution
 * - Consentimiento de cookies
 * - Optimizaciones de rendimiento (preconnect, fonts)
 */

import "../styles/global.css";
import "@fontsource/inter/400.css";
import "@fontsource/inter/500.css";
import "@fontsource/inter/600.css";
import "@fontsource/inter/700.css";
import "@fontsource/inter/800.css";

import Analytics from "@vercel/analytics/astro";
import ChatWidget from "../components/ChatWidget";

interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
  noIndex?: boolean;
}

const {
  title = "Automatización Inteligente | Ahorrar 260h/año | AI Revolution",
  description = "Automatiza procesos repetitivos con IA. Auditoría gratuita. 50+ empresas confían en nosotros. Ahorra 260h/año confirmadas.",
  ogImage = "/og-image.jpg",
  noIndex = false,
} = Astro.props;

// Variables de entorno
const isDevelopment = import.meta.env.DEV;
const siteUrl = Astro.site?.href || import.meta.env.PUBLIC_SITE_URL || "https://airevolution.es";
const GA_MEASUREMENT_ID = import.meta.env.PUBLIC_GA_MEASUREMENT_ID || "";
const RECAPTCHA_SITE_KEY = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY || "";

// URL del webhook de chat para preconnect (optimización de rendimiento)
const webhookUrl = import.meta.env.PUBLIC_N8N_CHAT_WEBHOOK_URL ||
                   (import.meta.env.PUBLIC_N8N_WEBHOOK_PROXY && import.meta.env.PUBLIC_N8N_WEBHOOK_ID
                     ? `${import.meta.env.PUBLIC_N8N_WEBHOOK_PROXY}/webhook/${import.meta.env.PUBLIC_N8N_WEBHOOK_ID}/chat`
                     : null);
const webhookOrigin = webhookUrl ? new URL(webhookUrl).origin : null;

const canonicalURL = new URL(Astro.url.pathname, siteUrl);

// Structured Data (JSON-LD) para SEO
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "ProfessionalService",
  name: "AI Revolution",
  alternateName: "Francisco Fernández Navarro",
  description: "Automatización e Inteligencia Artificial para Empresas",
  url: siteUrl,
  image: new URL("/logo.png", siteUrl).href,
  address: {
    "@type": "PostalAddress",
    streetAddress: "Carrer Casals",
    addressLocality: "Barcelona",
    postalCode: "08031",
    addressCountry: "ES",
  },
  contactPoint: {
    "@type": "ContactPoint",
    contactType: "sales",
    email: "airevolutionofficial1@gmail.com",
  },
  areaServed: "ES",
  priceRange: "$$",
  sameAs: [
    "https://www.linkedin.com/in/ai-revolution-rai-70b2a5398/",
    "https://www.instagram.com/ai_revolutionagency/",
  ],
};
---

<!doctype html>
<html lang="es" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />

    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />
    <link rel="sitemap" href="/sitemap-index.xml" />
    {noIndex && <meta name="robots" content="noindex, nofollow" />}

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(ogImage, canonicalURL)} />
    <meta property="og:site_name" content="AI Revolution" />
    <meta property="og:locale" content="es_ES" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalURL} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={new URL(ogImage, canonicalURL)} />

    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="theme-color" content="#0B0D73" />
    <meta name="msapplication-TileColor" content="#0B0D73" />

    <!-- Preconnect para recursos críticos externos -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    {GA_MEASUREMENT_ID && (
      <>
        <link rel="preconnect" href="https://www.google-analytics.com" />
        <link rel="preconnect" href="https://www.googletagmanager.com" />
      </>
    )}
    {webhookOrigin && (
      <link rel="preconnect" href={webhookOrigin} />
    )}
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- DNS Prefetch para recursos secundarios -->
    <link rel="dns-prefetch" href="https://www.google.com" />
    <link rel="dns-prefetch" href="https://www.gstatic.com" />
    <link rel="dns-prefetch" href="https://vercel.live" />

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

    <!-- Google Tag Manager -->
    {import.meta.env.PUBLIC_GTM_ID && (
      <script is:inline define:vars={{ GTM_ID: import.meta.env.PUBLIC_GTM_ID }}>
        // Inicializar dataLayer antes de GTM
        window.dataLayer = window.dataLayer || [];

        // Consent Mode v2 - Iniciar en modo denied ANTES de cargar GTM
        function gtag(){dataLayer.push(arguments);}
        window.gtag = gtag;
        gtag('consent', 'default', {
          ad_storage: 'denied',
          ad_user_data: 'denied',
          ad_personalization: 'denied',
          analytics_storage: 'denied',
          functionality_storage: 'denied',
          personalization_storage: 'denied',
          security_storage: 'granted',
          wait_for_update: 500
        });

        // Cargar GTM
        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer',GTM_ID);

        // Función helper para enviar pageview cuando haya consentimiento
        window.__sendGA4PageView = function() {
          window.dataLayer.push({
            'event': 'page_view_consent',
            'page_path': window.location.pathname + window.location.search,
            'page_title': document.title,
            'page_location': window.location.href
          });
        };
      </script>
    )}

    <!-- Variables de entorno para el cliente -->
    <script is:inline define:vars={{ RECAPTCHA_SITE_KEY }}>
      window.__ENV__ = {
        RECAPTCHA_SITE_KEY: RECAPTCHA_SITE_KEY || "",
      };
    </script>
    <!-- Meta Pixel Code -->
<script is:inline>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');

  fbq('init', '2842352925962983');

  // Flag para evitar enviar PageView múltiples veces
  window.__metaPixelPageViewSent = false;

  // Función helper para enviar PageView cuando haya consentimiento
  window.__sendMetaPixelPageView = function() {
    if (window.__metaPixelPageViewSent) return;
    if (typeof window.fbq === 'function') {
      fbq('track', 'PageView');
      window.__metaPixelPageViewSent = true;
    }
  };

  // Verificar si ya hay consentimiento guardado - disparar PageView solo si hay marketing consent
  try {
    var saved = localStorage.getItem('cookie_consent');
    if (saved) {
      var consent = JSON.parse(saved);
      if (consent.marketing) {
        window.__sendMetaPixelPageView();
      }
    }
  } catch (e) {}
</script>

<noscript>
  <img
    height="1"
    width="1"
    style="display:none"
    src="https://www.facebook.com/tr?id=2842352925962983&ev=PageView&noscript=1"
  />
</noscript>
<!-- End Meta Pixel Code -->

  </head>

  <body
    class="bg-white text-gray-900 antialiased selection:bg-[#FC31E6] selection:text-white"
  >
    <!-- GTM noscript fallback -->
    {import.meta.env.PUBLIC_GTM_ID && (
      <noscript>
        <iframe
          src={`https://www.googletagmanager.com/ns.html?id=${import.meta.env.PUBLIC_GTM_ID}`}
          height="0"
          width="0"
          style="display:none;visibility:hidden">
        </iframe>
      </noscript>
    )}

    <!-- Skip to main content (accesibilidad) -->
    <a href="#main-content" class="skip-link">Saltar al contenido principal</a>

    <main id="main-content">
      <slot />
      <Analytics />
      <ChatWidget client:only="react" />
    </main>
  </body>

  <!-- Gestión de consentimiento de cookies -->
  <script is:inline define:vars={{ isDevelopment }}>
    // Escuchar actualizaciones de consentimiento
    window.addEventListener("cookieConsentUpdate", function (e) {
      const consent = e.detail;

      // Esperar a que gtag esté disponible
      function updateGA4Consent() {
        if (typeof window.gtag === "function") {
          // Actualizar Google Analytics
          window.gtag("consent", "update", {
            analytics_storage: consent.analytics ? "granted" : "denied",
            ad_storage: consent.marketing ? "granted" : "denied",
            ad_user_data: consent.marketing ? "granted" : "denied",
            ad_personalization: consent.marketing ? "granted" : "denied",
            functionality_storage: consent.preferences ? "granted" : "denied",
            personalization_storage: consent.preferences ? "granted" : "denied",
          });

          // Si se aceptan cookies de analytics, enviar pageview
          if (consent.analytics && window.__sendGA4PageView) {
            window.__sendGA4PageView();
          }
        } else {
          // Si gtag no está listo, esperar un poco y reintentar
          setTimeout(updateGA4Consent, 100);
        }
      }

      updateGA4Consent();

      // Actualizar Meta Pixel si hay consentimiento de marketing
      if (consent.marketing && window.__sendMetaPixelPageView) {
        window.__sendMetaPixelPageView();
      }
    });

    // Aplicar consentimiento guardado al cargar
    (function () {
      try {
        const saved = localStorage.getItem("cookie_consent");
        if (saved) {
          const consent = JSON.parse(saved);
          window.dispatchEvent(
            new CustomEvent("cookieConsentUpdate", { detail: consent })
          );

          // Si ya hay consentimiento de analytics, enviar pageview después de cargar
          if (consent.analytics) {
            // Esperar a que la página cargue completamente
            if (document.readyState === 'complete') {
              setTimeout(function() {
                if (window.__sendGA4PageView) {
                  window.__sendGA4PageView();
                }
              }, 500);
            } else {
              window.addEventListener('load', function() {
                setTimeout(function() {
                  if (window.__sendGA4PageView) {
                    window.__sendGA4PageView();
                  }
                }, 500);
              });
            }
          }
        }
      } catch (e) {
        // Error loading consent - silently fail
      }
    })();
  </script>

  <!-- Live region para anuncios de accesibilidad -->
  <div
    id="live-region"
    class="live-region sr-only"
    role="status"
    aria-live="polite"
    aria-atomic="true"
  >
  </div>

  <!-- Performance monitoring (solo en producción) -->
  {
    !isDevelopment && (
      <script is:inline>
        {`
          // Web Vitals básico
          if ('PerformanceObserver' in window) {
            try {
              const observer = new PerformanceObserver((list) => {
                for (const entry of list.getEntries()) {
                  if (entry.entryType === 'largest-contentful-paint') {
                    console.log('LCP:', entry.renderTime || entry.loadTime);
                  }
                }
              });
              observer.observe({ entryTypes: ['largest-contentful-paint'] });
            } catch (e) {
              // Silencioso en caso de error
            }
          }
        `}
      </script>
    )
  }
</html>
