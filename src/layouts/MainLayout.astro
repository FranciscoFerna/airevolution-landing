---
import "../styles/global.css";
// Optimización de fuentes
import "@fontsource/inter/400.css";
import "@fontsource/inter/500.css";
import "@fontsource/inter/600.css";
import "@fontsource/inter/700.css";
import "@fontsource/inter/800.css";
import Analytics from "@vercel/analytics/astro";

interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
  noIndex?: boolean;
}

const {
  title = "Automatización Inteligente | Ahorrar 260h/año | AI Revolution",
  description = "Automatiza procesos repetitivos con IA. Auditoría gratuita. 50+ empresas confían en nosotros. Ahorra 260h/año confirmadas.",
  ogImage = "/og-image.jpg",
  noIndex = false,
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site || "https://airevolution.es");

// ✅ TU ID DE GOOGLE ANALYTICS
const GA_MEASUREMENT_ID = "G-V04T8BP151";

// Variables de entorno opcionales (reCAPTCHA sigue siendo necesario por env)
const RECAPTCHA_SITE_KEY = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY || "";

// SCHEMA JSON-LD
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  "name": "AI Revolution",
  "alternateName": "AI Revolution S.L.",
  "description": "Automatización e Inteligencia Artificial para Empresas",
  "url": "https://airevolution.es",
  "image": "https://airevolution.es/logo.png",
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "Carrer Casals",
    "addressLocality": "Barcelona",
    "postalCode": "08031",
    "addressCountry": "ES"
  },
  "contactPoint": {
    "@type": "ContactPoint",
    "contactType": "sales",
    "telephone": "+34-XXX-XXX-XXX",
    "email": "airevolutionofficial1@gmail.com"
  },
  "areaServed": "ES",
  "priceRange": "$$",
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.8",
    "ratingCount": "50"
  }
};
---

<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />

    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />
    <link rel="sitemap" href="/sitemap-index.xml" />
    {noIndex && <meta name="robots" content="noindex, nofollow" />}

    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(ogImage, canonicalURL)} />
    <meta property="og:locale" content="es_ES" />
    <meta property="og:site_name" content="AI Revolution" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalURL} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={new URL(ogImage, canonicalURL)} />

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="theme-color" content="#0B0D73" />

    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

    <script async src={`https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`}></script>
    <script is:inline define:vars={{ GA_MEASUREMENT_ID }}>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      // Configuración inicial (Denegado por defecto para cumplir GDPR hasta que acepten cookies)
      gtag('consent', 'default', {
        'ad_storage': 'denied',
        'ad_user_data': 'denied',
        'ad_personalization': 'denied',
        'analytics_storage': 'denied'
      });

      gtag('config', GA_MEASUREMENT_ID, { 'anonymize_ip': true });
    </script>

    <script is:inline define:vars={{ RECAPTCHA_SITE_KEY }}>
      window.__ENV__ = { RECAPTCHA_SITE_KEY };
    </script>

    <Analytics />
  </head>

  <body class="bg-white text-gray-900 antialiased selection:bg-[#FC31E6] selection:text-white">
    <a href="#main-content" class="skip-link">Saltar al contenido</a>

    <div id="live-region" role="status" aria-live="polite" class="sr-only"></div>

    <main id="main-content">
      <slot />
    </main>

    <script is:inline>
      window.addEventListener('cookieConsentUpdate', function(e) {
        const consent = e.detail;
        if (typeof window.gtag === 'function') {
          window.gtag('consent', 'update', {
            'analytics_storage': consent.analytics ? 'granted' : 'denied',
            'ad_storage': consent.marketing ? 'granted' : 'denied',
            'ad_user_data': consent.marketing ? 'granted' : 'denied',
            'ad_personalization': consent.marketing ? 'granted' : 'denied'
          });
          console.log('GA4 Consent Updated:', consent);
        }
      });
    </script>
  </body>
</html>
